<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</title>
  <style>
    :root {
      --text: #333;
      --border: #ccc;
      --bg: #fff;
      --primary: #007bff;
      --danger: #dc3545;
      --success: #28a745;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f8f9fa;
      padding: 10px;
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h2, h3 {
      text-align: center;
      margin: 16px 0 12px;
      color: var(--text);
      font-size: 18px;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.4;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 12px 0;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #444;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
    }
    thead th {
      font-weight: 600;
      background: #f8f9fa;
    }
    .preview-table th, .preview-table td {
      border: none;
      border-bottom: 1px solid #000;
    }
    .btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      margin: 5px;
    }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn-delete { background: var(--danger); padding: 2px 6px; font-size: 12px; }
    .no-print {
      display: block;
      text-align: center;
      margin-top: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 8px 16px;
      background: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: var(--primary);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .archive-list {
      display: grid;
      gap: 12px;
      margin-top: 10px;
    }
    .archive-item {
      padding: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #fafafa;
      font-size: 14px;
    }
    .archive-date-header {
      background: #e9ecef;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: bold;
      margin-top: 20px;
    }
    .archive-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 8px;
    }
    .status-zayavka { background: #d1ecf1; color: #0c5460; }
    .status-zakaz { background: #d4edda; color: #155724; }
    .archive-actions {
      margin-top: 10px;
      text-align: right;
    }
    .signature-line {
      margin-top: 30px;
      display: flex;
      align-items: flex-end;
      gap: 30px;
    }
    .signature-block {
      width: 50%;
    }
    #total-display {
      margin-top: 12px;
      text-align: right;
      font-size: 16px;
      font-weight: bold;
    }
    .user-info {
      position: absolute;
      top: 10px;
      right: 20px;
      background: #e9ecef;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 13px;
    }
    .user-info button {
      margin-left: 8px;
      padding: 2px 8px;
      font-size: 12px;
      background: #6c757d;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>

<div class="container">
  <div class="user-info" id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('form')">–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    <button class="tab-btn" onclick="switchTab('archive')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- === –§–û–†–ú–ê === -->
  <div id="form-tab" class="tab-content active">
    <!-- –°–ö–†–´–¢–û–ï –ü–û–õ–ï –î–õ–Ø ID -->
    <input type="hidden" id="claim-id">

    <div class="header-row">
      <div>–î–∞—Ç–∞: <span id="current-date"></span></div>
      <div>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: <input type="text" id="order-number" readonly></div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞</label>
        <input type="text" id="client-company" placeholder="–û–û–û '–ü—Ä–∏–º–µ—Ä'">
      </div>
      <div class="form-group">
        <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
        <input type="text" id="contact-person" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
      </div>
      <div class="form-group">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="tel" id="phone" placeholder="+7 (XXX) XXX-XX-XX">
      </div>
    </div>

    <h3>–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</h3>
    <div class="form-row">
      <div class="form-group">
        <label>–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å</label>
        <input type="text" id="car-model" placeholder="Mercedes-Benz Actros">
      </div>
      <div class="form-group">
        <label>–ì–æ—Å–Ω–æ–º–µ—Ä</label>
        <input type="text" id="car-number" placeholder="–ê123–ë–í 77">
      </div>
      <div class="form-group">
        <label>VIN</label>
        <input type="text" id="vin" placeholder="WDB94400000000000">
      </div>
    </div>

    <h3>–ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç</h3>
    <table id="works-table">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</th>
          <th>–ï–¥. –∏–∑–º.</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–°—É–º–º–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="works-body">
        <!-- —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </tbody>
    </table>
    <button class="btn btn-sm" onclick="addWorkRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>

    <h3>–ü–µ—Ä–µ—á–µ–Ω—å –∑–∞–ø—á–∞—Å—Ç–µ–π</h3>
    <table id="parts-table">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏</th>
          <th>–ï–¥. –∏–∑–º.</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–°—É–º–º–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="parts-body">
        <!-- —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </tbody>
    </table>
    <button class="btn btn-sm" onclick="addPartRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å</button>

    <div id="total-display">–û–±—â–∞—è —Å—É–º–º–∞: 0.00 ‚ÇΩ</div>

    <div class="no-print">
      <button class="btn" onclick="printClaim()">üìÑ –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    </div>
  </div>

  <!-- === –ê–†–•–ò–í === -->
  <div id="archive-tab" class="tab-content">
    <h2>–ê—Ä—Ö–∏–≤ –∑–∞—è–≤–æ–∫</h2>
    <div id="archive-list" class="archive-list"></div>
    <div class="no-print" style="margin-top:20px;">
      <button class="btn btn-archive" style="background:#6c757d;" onclick="switchTab('form')">‚Üê –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    </div>
  </div>
</div>

<script>
  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyDixYVempEv1EIehC_oSMI98stT61deZ6Y",
    authDomain: "servistransavto-danik.firebaseapp.com",
    databaseURL: "https://servistransavto-danik-default-rtdb.firebaseio.com",
    projectId: "servistransavto-danik",
    storageBucket: "servistransavto-danik.firebasestorage.app",
    messagingSenderId: "770451755248",
    appId: "1:770451755248:web:94874fca1cb9843945f235"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();

  let workIndex = 1, actualIndex = 1, partIndex = 1;
  let lastSeq = parseInt(localStorage.getItem('lastClaimSeq') || '0');
  let currentUser = null;

  // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById('user-info').innerHTML = `
        üë§ ${user.displayName || user.email} 
        <button onclick="signOut()">–í—ã—Ö–æ–¥</button>
      `;
      init();
    } else {
      document.getElementById('user-info').innerHTML = `
        <button onclick="signInWithGoogle()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      `;
    }
  });

  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => {
      alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
    });
  }

  function signOut() {
    auth.signOut().then(() => {
      window.location.reload();
    });
  }

  function init() {
    const now = new Date();
    const d = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
    document.getElementById('current-date').textContent = d;
    generateOrderNumber();
    loadFromFirebase();
    setInterval(loadFromFirebase, 10000);
  }

  function generateOrderNumber() {
    lastSeq++;
    localStorage.setItem('lastClaimSeq', lastSeq.toString());
    document.getElementById('order-number').value = `–°–¢–ê-${new Date().getFullYear()}-${String(lastSeq).padStart(3, '0')}`;
  }

  function resetForm() {
    document.getElementById('claim-id').value = '';
    document.getElementById('client-company').value = '';
    document.getElementById('contact-person').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('car-model').value = '';
    document.getElementById('car-number').value = '';
    document.getElementById('vin').value = '';

    // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü
    document.getElementById('works-body').innerHTML = '';
    document.getElementById('parts-body').innerHTML = '';
    workIndex = 1;
    partIndex = 1;
    calculateTotal();
  }

  function addWorkRow() {
    const tbody = document.getElementById('works-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${workIndex}</td>
      <td><input type="text" placeholder="–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞" oninput="calculateTotal()" /></td>
      <td><input type="text" value="—à—Ç." placeholder="—à—Ç." oninput="calculateTotal()" /></td>
      <td><input type="number" value="1" min="1" oninput="calculateTotal()" /></td>
      <td><input type="number" value="0" min="0" oninput="calculateTotal()" /></td>
      <td class="sum-cell">0.00</td>
      <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row);
    workIndex++;
  }

  function addPartRow() {
    const tbody = document.getElementById('parts-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${partIndex}</td>
      <td><input type="text" placeholder="–§–∏–ª—å—Ç—Ä –º–∞—Å–ª—è–Ω—ã–π" oninput="calculateTotal()" /></td>
      <td><input type="text" value="—à—Ç." placeholder="—à—Ç." oninput="calculateTotal()" /></td>
      <td><input type="number" value="1" min="1" oninput="calculateTotal()" /></td>
      <td><input type="number" value="0" min="0" oninput="calculateTotal()" /></td>
      <td class="sum-cell">0.00</td>
      <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row);
    partIndex++;
  }

  function deleteRow(button) {
    button.closest('tr').remove();
    calculateTotal();
  }

  function calculateTotal() {
    let total = 0;

    // –†–∞–±–æ—Ç—ã
    Array.from(document.querySelectorAll('#works-body tr')).forEach(row => {
      const qty = parseFloat(row.querySelector('input:nth-child(4)').value) || 0;
      const price = parseFloat(row.querySelector('input:nth-child(5)').value) || 0;
      const sum = qty * price;
      row.querySelector('.sum-cell').textContent = sum.toFixed(2);
      total += sum;
    });

    // –ó–∞–ø—á–∞—Å—Ç–∏
    Array.from(document.querySelectorAll('#parts-body tr')).forEach(row => {
      const qty = parseFloat(row.querySelector('input:nth-child(4)').value) || 0;
      const price = parseFloat(row.querySelector('input:nth-child(5)').value) || 0;
      const sum = qty * price;
      row.querySelector('.sum-cell').textContent = sum.toFixed(2);
      total += sum;
    });

    document.getElementById('total-display').textContent = `–û–±—â–∞—è —Å—É–º–º–∞: ${total.toFixed(2)} ‚ÇΩ`;
  }

  function prepareData(status) {
    const order = document.getElementById('order-number').value;
    const clientCompany = document.getElementById('client-company').value;
    const contactPerson = document.getElementById('contact-person').value;
    const phone = document.getElementById('phone').value;
    const carModel = document.getElementById('car-model').value;
    const carNumber = document.getElementById('car-number').value;
    const vin = document.getElementById('vin').value;

    if (!order || !clientCompany || !contactPerson || !phone || !carModel) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
      return null;
    }

    const works = [];
    Array.from(document.querySelectorAll('#works-body tr')).forEach((row, i) => {
      const name = row.querySelector('input:nth-child(2)').value;
      const unit = row.querySelector('input:nth-child(3)').value;
      const qty = parseFloat(row.querySelector('input:nth-child(4)').value) || 0;
      const price = parseFloat(row.querySelector('input:nth-child(5)').value) || 0;
      if (name && qty > 0) {
        works.push({
          id: i + 1,
          name,
          unit,
          qty,
          price,
          sum: qty * price
        });
      }
    });

    const parts = [];
    Array.from(document.querySelectorAll('#parts-body tr')).forEach((row, i) => {
      const name = row.querySelector('input:nth-child(2)').value;
      const unit = row.querySelector('input:nth-child(3)').value;
      const qty = parseFloat(row.querySelector('input:nth-child(4)').value) || 0;
      const price = parseFloat(row.querySelector('input:nth-child(5)').value) || 0;
      if (name && qty > 0) {
        parts.push({
          id: i + 1,
          name,
          unit,
          qty,
          price,
          sum: qty * price
        });
      }
    });

    return {
      header: {
        order,
        date: document.getElementById('current-date').textContent,
        clientCompany,
        contactPerson,
        phone,
        carModel,
        carNumber,
        vin,
        status: status || 'zayavka',
        userId: currentUser ? currentUser.uid : 'anonymous'
      },
      works,
      parts,
      total: parseFloat(document.getElementById('total-display').textContent.replace(/[^0-9.-]/g, '')) || 0
    };
  }

  function printClaim() {
    const data = prepareData('zayavka');
    if (!data) return;

    saveOrUpdateClaim(data);
    printClaimDocument();
    resetForm();
  }

  function saveOrUpdateClaim(data) {
    const claimId = document.getElementById('claim-id').value;
    let ref;
    
    if (claimId) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
      ref = database.ref('claims/' + claimId);
    } else {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∑–∞—è–≤–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É
      database.ref('claims').orderByChild('header/order').equalTo(data.header.order).once('value')
        .then(snapshot => {
          if (snapshot.exists()) {
            alert(`‚ö†Ô∏è –ó–∞—è–≤–∫–∞ ‚Ññ${data.header.order} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!`);
            return;
          }

          // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
          ref = database.ref('claims').push();
          data.id = ref.key;
          
          ref.set(data)
            .then(() => {
              exportTo1C(data);
              alert(`‚úÖ –ó–∞—è–≤–∫–∞ ‚Ññ${data.header.order} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`);
            })
            .catch(err => {
              alert('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.');
              exportTo1C(data);
            });
        });
    }
  }

  function loadClaim(orderId) {
    const list = JSON.parse(localStorage.getItem('claims') || '[]');
    const item = list.find(x => x.header.order === orderId);
    if (!item) return;

    switchTab('form');
    
    // ‚Üê –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú ID
    document.getElementById('claim-id').value = item.id;
    
    // ... (–∑–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è) ...
    document.getElementById('client-company').value = item.header.clientCompany;
    document.getElementById('contact-person').value = item.header.contactPerson;
    document.getElementById('phone').value = item.header.phone;
    document.getElementById('car-model').value = item.header.carModel;
    document.getElementById('car-number').value = item.header.carNumber;
    document.getElementById('vin').value = item.header.vin;

    // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü
    document.getElementById('works-body').innerHTML = '';
    document.getElementById('parts-body').innerHTML = '';

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç
    item.works.forEach(work => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${work.id}</td>
        <td><input type="text" value="${work.name}" oninput="calculateTotal()" /></td>
        <td><input type="text" value="${work.unit}" oninput="calculateTotal()" /></td>
        <td><input type="number" value="${work.qty}" min="1" oninput="calculateTotal()" /></td>
        <td><input type="number" value="${work.price}" min="0" oninput="calculateTotal()" /></td>
        <td class="sum-cell">${work.sum.toFixed(2)}</td>
        <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
      `;
      document.getElementById('works-body').appendChild(row);
    });

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–µ–π
    item.parts.forEach(part => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${part.id}</td>
        <td><input type="text" value="${part.name}" oninput="calculateTotal()" /></td>
        <td><input type="text" value="${part.unit}" oninput="calculateTotal()" /></td>
        <td><input type="number" value="${part.qty}" min="1" oninput="calculateTotal()" /></td>
        <td><input type="number" value="${part.price}" min="0" oninput="calculateTotal()" /></td>
        <td class="sum-cell">${part.sum.toFixed(2)}</td>
        <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
      `;
      document.getElementById('parts-body').appendChild(row);
    });

    calculateTotal();
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(`${tab}-tab`).classList.add('active');
    document.querySelector(`.tab-btn:nth-child(${tab === 'form' ? 1 : 2})`).classList.add('active');
    
    // –ù–ï –û–ß–ò–©–ê–ï–ú –§–û–†–ú–£ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –Ω–µ—ë, –µ—Å–ª–∏ –µ—Å—Ç—å claim-id
    if (tab === 'form') {
      const claimId = document.getElementById('claim-id').value;
      if (!claimId) {
        resetForm();
      }
    }
  }

  function renderArchive() {
    const archiveList = document.getElementById('archive-list');
    archiveList.innerHTML = '';

    database.ref('claims').orderByChild('header/date').once('value')
      .then(snapshot => {
        const claims = [];
        snapshot.forEach(childSnapshot => {
          claims.push({ id: childSnapshot.key, ...childSnapshot.val() });
        });

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
        const grouped = {};
        claims.forEach(claim => {
          const date = claim.header.date.split('.')[2]; // –≥–æ–¥
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push(claim);
        });

        for (const year in grouped) {
          const yearDiv = document.createElement('div');
          yearDiv.className = 'archive-date-header';
          yearDiv.textContent = `üìÖ ${year}`;
          archiveList.appendChild(yearDiv);

          grouped[year].forEach(claim => {
            const item = document.createElement('div');
            item.className = 'archive-item';
            item.innerHTML = `
              <strong>‚Ññ${claim.header.order}</strong> ‚Äî ${claim.header.clientCompany}
              <br>–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${claim.header.carModel} (${claim.header.carNumber})
              <br>–î–∞—Ç–∞: ${claim.header.date}
              <div class="archive-status status-${claim.header.status}">
                ${claim.header.status === 'zayavka' ? '–ó–∞—è–≤–∫–∞' : '–ó–∞–∫–∞–∑'}
              </div>
              <div class="archive-actions">
                <button class="btn-sm" onclick="loadClaim('${claim.header.order}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn-sm btn-delete" onclick="deleteClaim('${claim.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `;
            archiveList.appendChild(item);
          });
        }
      })
      .catch(err => {
        archiveList.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞.</p>';
      });
  }

  function deleteClaim(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

    database.ref('claims/' + id).remove()
      .then(() => {
        alert('‚úÖ –ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞.');
        renderArchive();
      })
      .catch(err => {
        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
      });
  }

  function exportTo1C(data) {
    console.log('–≠–∫—Å–ø–æ—Ä—Ç –≤ 1–°:', data);
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ API 1–°
    // –ù–∞–ø—Ä–∏–º–µ—Ä: fetch('/api/export-to-1c', { method: 'POST', body: JSON.stringify(data) })
    alert('üì¶ –≠–∫—Å–ø–æ—Ä—Ç –≤ 1–° –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –ø–æ –≤–∞—à–µ–º—É API.');
  }

  function printClaimDocument() {
    const printWindow = window.open('', '_blank');
    const html = `
      <html>
        <head>
          <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Ññ${document.getElementById('order-number').value}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
            th, td { border: 1px solid #000; padding: 6px; text-align: left; }
            .header { text-align: center; margin-bottom: 20px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Ññ${document.getElementById('order-number').value}</h2>
            <p>–î–∞—Ç–∞: ${document.getElementById('current-date').textContent}</p>
          </div>
          <h3>–ö–ª–∏–µ–Ω—Ç</h3>
          <p>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è: ${document.getElementById('client-company').value}</p>
          <p>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ: ${document.getElementById('contact-person').value}</p>
          <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${document.getElementById('phone').value}</p>
          <h3>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</h3>
          <p>–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å: ${document.getElementById('car-model').value}</p>
          <p>–ì–æ—Å–Ω–æ–º–µ—Ä: ${document.getElementById('car-number').value}</p>
          <p>VIN: ${document.getElementById('vin').value}</p>
          <h3>–†–∞–±–æ—Ç—ã</h3>
          <table>
            <thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ï–¥.</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th></tr></thead>
            <tbody>
              ${Array.from(document.querySelectorAll('#works-body tr')).map(row => {
                const cells = row.querySelectorAll('input');
                return `<tr><td>${row.querySelector('td:first-child').textContent}</td><td>${cells[0].value}</td><td>${cells[1].value}</td><td>${cells[2].value}</td><td>${cells[3].value}</td><td>${row.querySelector('.sum-cell').textContent}</td></tr>`;
              }).join('')}
            </tbody>
          </table>
          <h3>–ó–∞–ø—á–∞—Å—Ç–∏</h3>
          <table>
            <thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ï–¥.</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th></tr></thead>
            <tbody>
              ${Array.from(document.querySelectorAll('#parts-body tr')).map(row => {
                const cells = row.querySelectorAll('input');
                return `<tr><td>${row.querySelector('td:first-child').textContent}</td><td>${cells[0].value}</td><td>${cells[1].value}</td><td>${cells[2].value}</td><td>${cells[3].value}</td><td>${row.querySelector('.sum-cell').textContent}</td></tr>`;
              }).join('')}
            </tbody>
          </table>
          <h3>–ò—Ç–æ–≥–æ</h3>
          <p>${document.getElementById('total-display').textContent}</p>
        </body>
      </html>
    `;
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
  }

  // --- –ó–ê–ì–†–£–ó–ö–ê –ê–†–•–ò–í–ê ---
  function loadFromFirebase() {
    if (!currentUser) return;
    renderArchive();
  }

  // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
  document.addEventListener('DOMContentLoaded', () => {
    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤—Ö–æ–¥–∞
    if (!currentUser) {
      document.getElementById('user-info').innerHTML = `
        <button onclick="signInWithGoogle()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
      `;
    }
  });
</script>

</body>
</html>
